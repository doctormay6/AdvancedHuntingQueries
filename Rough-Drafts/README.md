# Rough Draft Queries

Clicking on the name of the query will bring you to the file for it in this git repo.

***Or try them out right away in your M365 Security tenant:***

Click on the 'ðŸ”Ž' hotlink to plug the query right into your Advanced Hunting Query page

### [ðŸ”Ž](https://security.microsoft.com/v2/advanced-hunting?query=H4sIAAAAAAAAA9VZbW_bNhC-zwX2H5QOaGPAtbOkb0vRD16aNFnnNFuaFMU2dKok22ps2bDsZBmG_vY-91CqIolOY0cOYAiySd7x3ng8Hk9NaYojLfHFlZFMJEDLkY6MZSgDtPakj9ZYQsAj9P9AbyI9eSgxevflNfo6o83_AK1j4HYx1yX2FPMD4P0g98BJeY3R78g2Wj1QmoBrjJ7CupgZY6TBlnKZyif0PMrSlEPMHMqmbMm_soH-c_kJjw-cDfkZ_Hw8T9DakKeAufIM73P0NtHaAuwZ5j8B76f438C_yqTSTSDLhZyRdwT5p2iNIIGHd8jeESip3BEwVO-XeH25RN-FZIq5Ln9Cywu0I_yqxXxIHkBS1b5OW2nPw2-_BBlhxgX6Y7QiWiAPH1AiY4085Jw2UzmLEJV8wtUbQrcM-rfU5MUcuu9gHULg-okFZmvvoVfWOtMtBiXV3qb_BaHFcR316H0ji1W8a6EKUw9z0VL9bPAxfSuyQFXXLsbP0dqCBxXhPau0xhq21TOS2CBhMlae16EfdWj9ICdjeQ1jYKqst_FejQAurZbJMOHe8zA-uaLnFt6RZRV7eB8BW_dvERpxNMJY2ZYmDvhWDV-hf04pA2iiccmjNWLZxXiqlWI6hcfEG5v_Kfb_9PweIRq38rR3qPeAUc-X3yi5Yhl_0bUM6TcqvwOdDzF-xF5eEl3B29B-JO8ZKUNGN9XWzmH9lvIH_DfYi8r7kTvSUPwVZ8ovaNVWQtpjOZFT-SAHKyTx77DvHqy8h33VWhm5XfjzqTxeIUsfrJQnH0HaVfIG9eI-JN6_1osXl7oBDI3_ETMhzRE10xkTowt7VB2vy_zS87t6Xi-S3KFM2Zx8Hs-2CfPAMDn1quOu_uAzb0kz_6r1Uz2u55Ce8IaDD00H6FWvp7nN2LlrBqXvGXOk_yrnHgN2Bs3GWMEYsOqtPML9a5s72q6hufEF5DPK8XGWZnNz59P822Pm6zNvq-OeqVghskLDt3przOL8I24Bj--Mn_NNU_-ONXXuSFNH_gGn5XO5Cx7L9kpdG6WrlZkpV8m-U8esEQS89VUrQZNniIdIpPfN7Wtiod6rq-V9zhkubaCjDk8Dc_MNGCF7hA5ZL6ja9qYSoBl3C5nrLlr78gZz2vIXHh1tV86zTVvr7BhvB1Dl9Z4YqZ46ssNzIb3bnya33JAUFa71t_KN0axVbKkUOLz9m2pPMdYHM3xqHRlyxHpdyBPQZFZ53feSHOiQFQfVWrG-cPY8lbeaZNnn4jSLFa3azGx5Ec16rDh9pJyXpHLz2kxRDvOkGt8me9dKxzCp9xT9oTq_jcRUo6b0l7GUM4rqeI2S9dD8LFoqpxjrGDPWmPijdbnlcXvATPYB897eUjl59KpmkvmVd4GJE1c9x6Fvayz8gPcdomG78ntm3lMz728B2-Ou0RmvSNFNzgMbnZacQMJ9eYsomFUbjE67rMT36acmWsbWmmDE3HfdsstfMtKUa96ZvIvEjpSq7UtBzSphmcZaQuMzdsgmYC4t5iVzMno2aovIvMZ68n1geoh65tvHWYFX5k0t3JCmCbcW6-9qsW4SARevy67N8PAe5w5pB93Bl5BKJexWagFj8fKp3cCYSmo0HCRaNrB3Ap4JYUK1Ab369G0_N8Nn9Vu_X2gdXivurW-2yq9k6teHmDG_f39f63l28A7yQ5OvHFCet2gdc8TjftGvCcYfdWy-PTOPHEr9hBQjxm83-fb0SczXjGxHmUznM2Ounl_veKcPklmaeeuXiqtfItLVr1v2YP2GXltfyN9uNms2x3wcvUo1Dznht8ivnyLIXSAeAAA&timeRangeId=week) [Detect All The Things](DetectAllTheThings.kusto)

- One rule to detect the most common initial access and execution methods
- Looks for uncommon parent/child process combinations
- Adapted from from [Florian Roth](https://twitter.com/cyb3rops)'s (["God Mode Sigma Rule"](https://gist.github.com/Neo23x0/811db09add59068a7a80273d7e5f6e0f))
- Still too many false positives to turn into a detection rule
- Missing some things from the original rule

### [ðŸ”Ž](https://security.microsoft.com/v2/advanced-hunting?query=H4sIAAAAAAAAA61V22rbQBQ8z4X-gyooOOCkF2hfWlNKk16ghIDzVkpRLTmO40jCktO0hH57Z2a9luR1aj0EIe3u2bNzZs9NC8ustsjObInZjSW2wJjbBN9zm0laYSwgT6E3wvvCnut5g_kzPBFOpTa3FTRrrSp8c5zMIOf72B7ZsfAvhXyCGa3U0OTeHfR_wUome5G9h1YN3QI65_bbSklHsh7bWHoe6wt0aJfMF7IWC5PMDvFENtVeJYwSmBVOEv1Gd_O62xw-QoN4pzh9LckT2CvEOsFerlvG2LmVRiltriaYrWSF2keSZQGrEyAf92JHZsSo5bNU_knxXG58RATyzRSlah2nGnspvJeLH7012Hvy4B6LXZ83PvF2GIGlvHLRw8qRfQvi6DFj-96TBbOEEVkpJg_JpYvcn9FYubHEt521D8UqRO8ymwOJ-JFdaUxhm2MulKhTgT6725UYiUmY-bsqdGyfcYeX9speox-wNlxtxpueQGvTtZ-c_Rz4jNMEuCVmq40_IiAn6jOZePxVj3kqRlP5byar9JbLuyl2iFlhdBLySrTO7R3Wp-v-QzxacfVEhAvoeb_7u1Vgc40nEac_QvywlVtNRgzg9SEkX2WxVpwy9SrHz_Uj9gR3kri3OBXuO5x2ZKrWmSusf6g30GZby8fmAJo_kQ1h1IaSub5N_5_p1jPJ29EbbcVyeG-1hzvdOgn3w4z1_nYRKXTDhjv_Qoy4Ww1UAQ23uJXrpTTn0OKf4lDRZ0b4XNsfmf_f8xMYFPAs63LXv3FXTew7E9nb3n_aJi8L-c9Heb8N3nti_wAFgeAb2AcAAA&timeRangeId=week) [Globally Rare Service Installed](GloballyRareService.kusto)

- For each service installation, check the global prevalence of the service executable
- Idea from mRr3b00t [@UK_Daniel_Card](https://twitter.com/UK_Daniel_Card) ([link to tweet](https://twitter.com/UK_Daniel_Card/status/1657005272764760065))
- Query is slow and the join needs more scrutiny for correctness

### [ðŸ”Ž](https://security.microsoft.com/v2/advanced-hunting?query=H4sIAAAAAAAAA6WU3WrbQBCF57rQd9iKQlJo4zr9o4ZcpHZLe1NMHdqUpgTZVmpjRRKSbCdQ8uz9ZlaKJWNDISyWd2dnzpk5M1JHOuJkJLdSSCmRXHOaSM4u5DyXRP5gSTiXspaUm4V5pNjUOjEvPRWVfSmxTNmPuXXghdzdsitlVuEV8lgewavMp1XUNUtRnJyxhvyH-BXYJkSFlpuirjkpUo1X2C7H44o1x9tV1khuJCOX1CLqSn5gH8sA3u8WmfKc8lxzr76hsWjWMbbQlNhkG1mWpanhGUIsyhJJr-GXo0ICUsx6JcdyZL6qRx-_C6siqXgLzkVDf_W_4C6UFdXE-JXEe6znZK72kWXQJz6lH3ND7hL3Ds-X1a-LbQarqtCzvNoev3j-xtaRp_yW8EfkXbDPOI1hUzU7W1r4KF-N1jvgf2WekXxtTclH7JFl7_v917o3MxbN9wt3vjObSRtylxqW9v4T1thwVWWNOZE7nkFrXoOd6KeNyTzDO6viTyy-v2N-R1Q9uecOWl2_sU4s6YKixJajqqJVDPfUl9ikHIKeocRrubS5vOSUs1tVM30o3xpTpWjPWI5Vvx8fyNZtRTmbeFUs2sO-jerkiSmmXdSObN6jgBl4K-_p67G8Ic8jLDX7QD7DrtFXRPpuTJlCZ0qoTd_20jTRDi7kRUOdh-fl5zUwPVxDldgmP2NKQ7gW_83ku99jdVuou9Z-Jn-TWp7K1pyQ4v5rWHs-RIFzqj9vdeSnfWFz48_p_4F965pvbD2T_wDuYJTv2gUAAA&timeRangeId=week) [System Process Network Connections](SystemProcessNetCons.kusto)

- Looks for network connections initiated from the System process
- A common TTP associated with this traffic is exploiting WebDAV to download malware
- Emotet example: `rundll32.exe C:\windows\system32\davclnt.dll,DavSetCookie 127.0.0.1 hxxp://127.0.0[.]1/$/users/public/malware[.]exe`
- Still some false positives
- Hard to investigate; needs a recommended investigation process or additional querying for context
