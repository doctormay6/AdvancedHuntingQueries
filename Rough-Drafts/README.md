# Rough Draft Queries

Clicking on the name of the query will bring you to the file for it in this git repo.

***Or try them out right away in your M365 Security tenant:***

Click on the 'ðŸ”Ž' hotlink to plug the query right into your Advanced Hunting Query page

### [ðŸ”Ž](https://security.microsoft.com/v2/advanced-hunting?query=H4sIAAAAAAAAA9VZbW_bNhC-zwX2H5QOaGPAtbOkb0vRD16aNFnnNFuaFMU2dKok22ps2bDsZBmG_vY-91CqIolOY0cOYAiySd7x3ng8Hk9NaYojLfHFlZFMJEDLkY6MZSgDtPakj9ZYQsAj9P9AbyI9eSgxevflNfo6o83_AK1j4HYx1yX2FPMD4P0g98BJeY3R78g2Wj1QmoBrjJ7CupgZY6TBlnKZyif0PMrSlEPMHMqmbMm_soH-c_kJjw-cDfkZ_Hw8T9DakKeAufIM73P0NtHaAuwZ5j8B76f438C_yqTSTSDLhZyRdwT5p2iNIIGHd8jeESip3BEwVO-XeH25RN-FZIq5Ln9Cywu0I_yqxXxIHkBS1b5OW2nPw2-_BBlhxgX6Y7QiWiAPH1AiY4085Jw2UzmLEJV8wtUbQrcM-rfU5MUcuu9gHULg-okFZmvvoVfWOtMtBiXV3qb_BaHFcR316H0ji1W8a6EKUw9z0VL9bPAxfSuyQFXXLsbP0dqCBxXhPau0xhq21TOS2CBhMlae16EfdWj9ICdjeQ1jYKqst_FejQAurZbJMOHe8zA-uaLnFt6RZRV7eB8BW_dvERpxNMJY2ZYmDvhWDV-hf04pA2iiccmjNWLZxXiqlWI6hcfEG5v_Kfb_9PweIRq38rR3qPeAUc-X3yi5Yhl_0bUM6TcqvwOdDzF-xF5eEl3B29B-JO8ZKUNGN9XWzmH9lvIH_DfYi8r7kTvSUPwVZ8ovaNVWQtpjOZFT-SAHKyTx77DvHqy8h33VWhm5XfjzqTxeIUsfrJQnH0HaVfIG9eI-JN6_1osXl7oBDI3_ETMhzRE10xkTowt7VB2vy_zS87t6Xi-S3KFM2Zx8Hs-2CfPAMDn1quOu_uAzb0kz_6r1Uz2u55Ce8IaDD00H6FWvp7nN2LlrBqXvGXOk_yrnHgN2Bs3GWMEYsOqtPML9a5s72q6hufEF5DPK8XGWZnNz59P822Pm6zNvq-OeqVghskLDt3przOL8I24Bj--Mn_NNU_-ONXXuSFNH_gGn5XO5Cx7L9kpdG6WrlZkpV8m-U8esEQS89VUrQZNniIdIpPfN7Wtiod6rq-V9zhkubaCjDk8Dc_MNGCF7hA5ZL6ja9qYSoBl3C5nrLlr78gZz2vIXHh1tV86zTVvr7BhvB1Dl9Z4YqZ46ssNzIb3bnya33JAUFa71t_KN0axVbKkUOLz9m2pPMdYHM3xqHRlyxHpdyBPQZFZ53feSHOiQFQfVWrG-cPY8lbeaZNnn4jSLFa3azGx5Ec16rDh9pJyXpHLz2kxRDvOkGt8me9dKxzCp9xT9oTq_jcRUo6b0l7GUM4rqeI2S9dD8LFoqpxjrGDPWmPijdbnlcXvATPYB897eUjl59KpmkvmVd4GJE1c9x6Fvayz8gPcdomG78ntm3lMz728B2-Ou0RmvSNFNzgMbnZacQMJ9eYsomFUbjE67rMT36acmWsbWmmDE3HfdsstfMtKUa96ZvIvEjpSq7UtBzSphmcZaQuMzdsgmYC4t5iVzMno2aovIvMZ68n1geoh65tvHWYFX5k0t3JCmCbcW6-9qsW4SARevy67N8PAe5w5pB93Bl5BKJexWagFj8fKp3cCYSmo0HCRaNrB3Ap4JYUK1Ab369G0_N8Nn9Vu_X2gdXivurW-2yq9k6teHmDG_f39f63l28A7yQ5OvHFCet2gdc8TjftGvCcYfdWy-PTOPHEr9hBQjxm83-fb0SczXjGxHmUznM2Ounl_veKcPklmaeeuXiqtfItLVr1v2YP2GXltfyN9uNms2x3wcvUo1Dznht8ivnyLIXSAeAAA&timeRangeId=week) [Detect All The Things](DetectAllTheThings.kusto)

- One rule to detect the most common initial access and execution methods
- Looks for uncommon parent/child process combinations
- Adapted from from [Florian Roth](https://twitter.com/cyb3rops)'s (["God Mode Sigma Rule"](https://gist.github.com/Neo23x0/811db09add59068a7a80273d7e5f6e0f))
- Still too many false positives to turn into a detection rule
- Missing some things from the original rule

### [ðŸ”Ž](https://security.microsoft.com/v2/advanced-hunting?query=H4sIAAAAAAAAA71XbWvTUBQ-nwX_QywIHexFB_pBHTLbTQduDDfxg4p0SdZ2S5PSm3abDH-7z3lyb5M06RpGldAmufe8Pc8599ybHdkRTz5KJIlcSA_3SO4w8gXPEwnxdIb_icxkKD7fD-QWd1-mkkLmAvKhPJUnsKOWjjGWYnaAUYN3s6Ad1mirXAr_-q96Q2h4col7RJ2hxHjT-R6eAtw12kSuqan-POkXEHgyZuwzvoXQ8W2M-qbSpzXz5_A9YTQDWIroZw-_l_KC11s8Zxh7mLsCAkNbPUYRQzPEuP7UU5f2M9QHeFIvKSR17h7yN0SaMbwPqRSyCWTOwf6Yo3v03lrg_wgyhtxFjD2ARJ3NQ8veCSRHHHlm7bXw75BolJeMLaCm4kiIyofeGE9TjCr__Ya5VKmEHhXRyGZ3C1fOkbE5nXFW5frMYsaAq6VM55JIDS2PMW8gpZKZbh1yh6DNWc9e7RpGMh4nzMsN7Q7IkIF1n1WgEtsWp6K45nzOX0RfiidBpK5-ja025zshs1X_LsMdRh7YGhkS8QGeJ6zDiNI6c8z674EtxeriaslGIaJvZDaA5s2c55TysV0b13i7I74eZ4uRuvWlVTa0saQ2_6eMxyc-8wCaevY0yubZWm69Kx_kK2OK8KzVuAsfBohMpbIj4g1YwTNb3-UaXjf2wNqO_wn2Y0Y9IbNab-qhWBOuTrYXeobBSIe1OkWERY2APBnUhPbfMeT2OR6Xos9ZPeLMlCvZI4qILLmut8jloe2kGs0pJQelun8jP3Bl7Pbxr4hzBgxnq6i9AhpvAY-3gCjbr1JiMrbDqNUO9Lo1c8ty9ZiqcB13hNkRu7pq1fFa7cP7thfMuBtOba_L--IB_HQb98dwjjOg7QDXcN5x1YJGHzJXxu57yl-AdRUTj-agvVJzY4nHcj0WKzvzo6vF7TOrvWzL98q-6Gy25GfDKHTX9VlFMWtqfbGULTeP6Gy-HxVPAeuKqmq9HJnaM7a2fTJSPMM4fjdrOtTmkpW-uTTz1ZkyZ9X5avQu7itoacy6s2V73x7vsV1J5e5axORwLJ7PnGyzc5pb5c5atvOEtiu2ShY3eBqI18BtXY86k0-IcVdeyWspn_cec9ob8GTrzvF_eA5-LuWTjjc_5Xk8oWc7bGJHNKoe32N5j_cTaXr-u6edKeyMmPWh_KbFzsJ6zSumDW6Vq8_0mLJ6QubJnUJTMjq2mmr3FlrV-cxOMT-moKOnp1_st-qzLoua4wt-Q9Xlspij_7M-MqYTRp7HlO1d7hurzW6RR1bcBceUvJKQ1b_FrGqmXQ2tZvxhnMVvz7rvsrpKX6XjyTtp-pWX11tC_lz2VvtQ3L78BTglE2VCDwAA&timeRangeId=week) [Globally Rare Service Installed](GloballyRareService.kusto)

- For each service installation, check the global prevalence of the service executable
- Idea from mRr3b00t [@UK_Daniel_Card](https://twitter.com/UK_Daniel_Card) ([link to tweet](https://twitter.com/UK_Daniel_Card/status/1657005272764760065))
- Query is slow and the join needs more scrutiny for correctness

### [ðŸ”Ž](https://security.microsoft.com/v2/advanced-hunting?query=H4sIAAAAAAAAA6WU3WrbQBCF57rQd9iKQlJo4zr9o4ZcpHZLe1NMHdqUpgTZVmpjRRKSbCdQ8uz9ZlaKJWNDISyWd2dnzpk5M1JHOuJkJLdSSCmRXHOaSM4u5DyXRP5gSTiXspaUm4V5pNjUOjEvPRWVfSmxTNmPuXXghdzdsitlVuEV8lgewavMp1XUNUtRnJyxhvyH-BXYJkSFlpuirjkpUo1X2C7H44o1x9tV1khuJCOX1CLqSn5gH8sA3u8WmfKc8lxzr76hsWjWMbbQlNhkG1mWpanhGUIsyhJJr-GXo0ICUsx6JcdyZL6qRx-_C6siqXgLzkVDf_W_4C6UFdXE-JXEe6znZK72kWXQJz6lH3ND7hL3Ds-X1a-LbQarqtCzvNoev3j-xtaRp_yW8EfkXbDPOI1hUzU7W1r4KF-N1jvgf2WekXxtTclH7JFl7_v917o3MxbN9wt3vjObSRtylxqW9v4T1thwVWWNOZE7nkFrXoOd6KeNyTzDO6viTyy-v2N-R1Q9uecOWl2_sU4s6YKixJajqqJVDPfUl9ikHIKeocRrubS5vOSUs1tVM30o3xpTpWjPWI5Vvx8fyNZtRTmbeFUs2sO-jerkiSmmXdSObN6jgBl4K-_p67G8Ic8jLDX7QD7DrtFXRPpuTJlCZ0qoTd_20jTRDi7kRUOdh-fl5zUwPVxDldgmP2NKQ7gW_83ku99jdVuou9Z-Jn-TWp7K1pyQ4v5rWHs-RIFzqj9vdeSnfWFz48_p_4F965pvbD2T_wDuYJTv2gUAAA&timeRangeId=week) [System Process Network Connections](SystemProcessNetCons.kusto)

- Looks for network connections initiated from the System process
- A common TTP associated with this traffic is exploiting WebDAV to download malware
- Emotet example: `rundll32.exe C:\windows\system32\davclnt.dll,DavSetCookie 127.0.0.1 hxxp://127.0.0[.]1/$/users/public/malware[.]exe`
- Still some false positives
- Hard to investigate; needs a recommended investigation process or additional querying for context
